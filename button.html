<html>
 <head>
   <title>Improved Puck.js connection</title>
 </head>
 <body>
  <pre id="log"></pre>
  <button>Click here to start</button><br/>
 
  <script src="https://www.puck-js.com/puck.js"></script>
  <script type="text/javascript">
   
var button = document.getElementsByTagName('button')[0];
var logelement = document.getElementById('log');

var EPS1V = 0;
var EPS2V = 0;
var EPSMAIN = 0;
var data = new Int16Array(100);

function log(txt) {
    logelement.innerHTML += txt + "\n";
}


function onLine(line) { // on recieving a line of data
    try { // attempt to parse the data
        var j = JSON.parse(line);
        var buffer1 = j.EPS1; // buffer for comparison - could not compare JSON objects?
        var buffer2 = j.EPS2;
        if (buffer1 !== undefined) {
            EPS1V = buffer1;
        };
        if (buffer2 !== undefined) {
            EPS2V = buffer2;
        };
        elements.EPS1.setValue(EPS1V);
        elements.EPS2.setValue(EPS2V);
        console.log("========================"); // debugging information sent to console
        console.log("j.EPS1=", j.EPS1);
        console.log("j.EPS2=", j.EPS2);
        console.log("buffer1=", buffer1);
        console.log("buffer2=", buffer2);
        console.log("EPS1V=", EPS1V);
        console.log("EPS2V=", EPS2V);
        console.log("EPS1V-EPS2V=", EPS1V - EPS2V);
        console.log("========================");
    } catch (e) { // else return failed line
        console.log("Failed Received: ", line);
    }
}

function log() { // A function to store the data in the history
    data.set(new Int16Array(data.buffer, 2)); // move all data values back by one
    data[data.length - 1] = (EPS1V - EPS2V * 100); // set the last data value to the difference between EPS values
    elements.graph.setData(data); // update graph
}

setInterval(log, 10); // log data at 10 ms intervals (same as aquisition)

// When clicked, connect or disconnect
var connection;
button.addEventListener("click", function() {
    if (connection) {
        log("Closing connection");
        connection.close();
        connection = undefined;
    }
    log("Opening connection");
    Puck.connect(function(c) {
        if (!c) {
            log("Couldn't connect!");
            return;
        }
        log("Connecting...");
        connection = c;
        // Handle the data we get back, and call 'onLine'
        // whenever we get a line
        var buf = "";
        connection.on("data", function(d) {
            buf += d;
            var i = buf.indexOf("\n");
            while (i >= 0) {
                onLine(buf.substr(0, i));
                buf = buf.substr(i + 1);
                i = buf.indexOf("\n");
            }
        });
        // First, reset Puck.js
        connection.write("reset();\n", function() { // First, reset Puck.js
            setTimeout(function() { // Wait for it to reset itself
                // Tell puck to write analogueRead to pins D28 & D29 to Bluetooth at 10 ms intervals
                // When disconnected, Puck.js resets so the setInterval doesn't keep draining battery.
                connection.write("setInterval(function(){Bluetooth.println(JSON.stringify({EPS1:analogRead(D28)}))},10);NRF.on('disconnect', function() {reset()});\n", function() {
                    console.log("Ready...");
                    connection.write("setInterval(function(){Bluetooth.println(JSON.stringify({EPS2:analogRead(D29)}))},10);NRF.on('disconnect', function() {reset()});\n", function() {
                        console.log("Ready...");
                    });
                }, 1000); //eo setTimeout});
            }, 1000); //eo setTimeout
        });
    });
});
   
   
  </script>
 </body>
</html>
